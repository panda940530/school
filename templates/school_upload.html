<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>計畫查詢入口</title>
  <style>
    :root{
      --bg:#fafafa;
      --card:#ffffff;
      --text:#333;
      --muted:#666;
      --border:#e5e5e5;
      --primary:#4CAF50;
      --primary-hover:#43a047;
      --shadow:0 2px 8px rgba(0,0,0,.08);
      --radius:10px;
    }
    *{box-sizing:border-box;}
    body{
      font-family:"Microsoft JhengHei", ui-sans-serif, system-ui;
      background:var(--bg);
      margin:0;
      padding:2rem;
      display:flex;
      justify-content:center;
    }
    .container{
      max-width:780px;
      width:100%;
    }
    h1{
      margin:0 0 .5rem;
      color:var(--text);
      font-size:1.6rem;
    }
    p.subtitle{
      margin:.1rem 0 1.5rem;
      color:var(--muted);
      font-size:.95rem;
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:1.25rem 1.5rem 1.5rem;
    }
    label{
      display:block;
      font-weight:600;
      margin-bottom:.4rem;
      color:var(--text);
    }
    textarea{
      width:100%;
      min-height:120px;
      resize:vertical;
      padding:.7rem .8rem;
      border-radius:8px;
      border:1px solid var(--border);
      font-family:inherit;
      font-size:.98rem;
      line-height:1.5;
    }
    textarea:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 2px rgba(76,175,80,.15);
    }
    .color-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:.75rem;
      margin-top:1rem;
    }
    .color-field{
      display:flex;
      align-items:center;
      gap:.4rem;
      padding:.55rem .65rem;
      border:1px solid var(--border);
      border-radius:8px;
      background:#fafafa;
    }
    .color-field label{
      margin:0;
      font-weight:500;
      font-size:.9rem;
      min-width:64px;
      color:var(--muted);
    }
    .color-field input[type="color"]{
      width:44px;
      height:32px;
      padding:0;
      border:none;
      background:transparent;
      cursor:pointer;
    }
    .voice-row{
      display:flex;
      align-items:center;
      gap:.5rem;
      margin-top:.2rem;
    }
    .voice-status{
      color:var(--muted);
      font-size:.9rem;
    }
    .hint{
      margin-top:.4rem;
      color:var(--muted);
      font-size:.85rem;
      line-height:1.4;
    }
    .examples{
      margin-top:.6rem;
      padding:.6rem .8rem;
      background:#f7f7f7;
      border-radius:8px;
      font-size:.85rem;
      color:var(--muted);
    }
    .examples div{
      margin-top:.1rem;
    }
    button{
      margin-top:1rem;
      background:var(--primary);
      color:#fff;
      border:none;
      border-radius:8px;
      padding:.6rem 1.4rem;
      cursor:pointer;
      font-size:1rem;
    }
    button:hover{
      background:var(--primary-hover);
    }
    .n8n-info{
      margin-top:1rem;
      font-size:.8rem;
      color:var(--muted);
    }
    code{
      background:#f3f3f3;
      padding:2px 6px;
      border-radius:4px;
      word-break:break-all;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>計畫查詢入口</h1>
    <p class="subtitle">輸入自然語言需求，由 n8n 連到資料庫查詢並回傳 AI 解說。</p>

    <div class="card">
      <form method="post">
        <label for="query">請輸入查詢內容（自然語言）</label>
        <textarea id="query" name="query" placeholder="例如：&#10;請做出本校111~114年度不同單位類別承接計畫件數、人數、金額之統計圖&#10;請計算各學院於 114 年度執行計畫之教師比例及人均值" required></textarea>
        <div class="hint">送出後由 Flask 轉送到 n8n Webhook，n8n 會跑 SQL / 查詢，結果表格與 AI 說明會呈現。</div>
        <div class="voice-row">
          <button type="button" id="voiceBtn" style="background:#ff9800;">語音輸入</button>
          <span id="voiceStatus" class="voice-status"></span>
        </div>
        {% set colors = default_bar_colors or ['#f57c00','#2e7d32','#1976d2','#7b1fa2'] %}
        <div class="hint">需要統計圖就在輸入問題輸入統計圖，顏色是按照你問的內容的順序的。</div>
        <div class="color-grid">
          <div class="color-field">
            <label for="color1">顏色 1</label>
            <input type="color" id="color1" name="color1" value="{{ colors[0] }}">
          </div>
          <div class="color-field">
            <label for="color2">顏色 2</label>
            <input type="color" id="color2" name="color2" value="{{ colors[1] }}">
          </div>
          <div class="color-field">
            <label for="color3">顏色 3</label>
            <input type="color" id="color3" name="color3" value="{{ colors[2] }}">
          </div>
          <div class="color-field">
            <label for="color4">顏色 4</label>
            <input type="color" id="color4" name="color4" value="{{ colors[3] }}">
          </div>
        </div>
        <button type="submit">送出查詢</button>
      </form>
      <div class="n8n-info">
        n8n Webhook URL：<code>{{ n8n_url }}</code>
      </div>
    </div>
  </div>
</body>
<script>
  (() => {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const btn = document.getElementById('voiceBtn');
    const statusEl = document.getElementById('voiceStatus');
    const textarea = document.getElementById('query');

    if (!SpeechRecognition) {
      if (btn) btn.disabled = true;
      if (statusEl) statusEl.textContent = '此瀏覽器不支援語音輸入';
      return;
    }

    const recognition = new SpeechRecognition();
    recognition.lang = 'zh-TW';
    recognition.interimResults = false;
    recognition.continuous = false;

    let listening = false;

    recognition.onstart = () => {
      listening = true;
      btn.textContent = '停止錄音';
      btn.style.background = '#e53935';
      statusEl.textContent = '錄音中…請開始說話';
    };
    recognition.onend = () => {
      listening = false;
      btn.textContent = '語音輸入';
      btn.style.background = '#ff9800';
      statusEl.textContent = '';
    };
    recognition.onerror = (e) => {
      statusEl.textContent = '錄音錯誤：' + (e.error || '');
    };
    recognition.onresult = (e) => {
      const text = Array.from(e.results).map(r => r[0].transcript).join('');
      if (text && textarea) {
        textarea.value = (textarea.value ? textarea.value + '\n' : '') + text.trim();
      }
    };

    btn.addEventListener('click', () => {
      if (!listening) recognition.start();
      else recognition.stop();
    });
  })();
</script>
</html>
